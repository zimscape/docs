image: vusakhoza/python:3.6

stages:
  - package
  - staging

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan $STAGING_IP >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

package:
  stage: package
  script:
    -
    - pip install mkdocs
    - mkdocs build

staging:
  stage: staging
  image: vusakhoza/zimscape-backend:1.0.0
  script:
    - ssh -t $SSH_USER@$STAGING_IP "rm -rf $PROJECT_PATH"
    - ssh -t $SSH_USER@$STAGING_IP "cd $BASE_PATH"
    - ssh -t $SSH_USER@$STAGING_IP "cd $BASE_PATH && git clone --single-branch --branch develop git@gitlab.zimscape.com:vusakhoza/zimscape-spring.git"
    - ssh -t $SSH_USER@$STAGING_IP "cd $PROJECT_PATH && mvn clean -P lab compile liquibase:update"
    - ssh -t $SSH_USER@$STAGING_IP "cd $PROJECT_PATH && mvn clean package"
    - ssh -t $SSH_USER@$STAGING_IP "cd $PROJECT_PATH && ./zimscape stop"
    - ssh -t $SSH_USER@$STAGING_IP "cd $PROJECT_PATH && ./zimscape start"


